<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leave Management Chatbot</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family: Arial, sans-serif; 
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
      height:100vh; 
      display:flex; 
      justify-content:center; 
      align-items:center; 
    }
    .chat-container { 
      width:90%; 
      max-width:600px; 
      height:80vh; 
      background:white; 
      border-radius:10px; 
      box-shadow:0 10px 30px rgba(0,0,0,0.3); 
      display:flex; 
      flex-direction:column; 
      overflow:hidden; 
    }
    .chat-header { 
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
      color:white; 
      padding:20px; 
      text-align:center; 
    }
    .chat-header h1{ 
      font-size:24px 
    }
    .chat-messages { 
      flex:1; 
      overflow-y:auto; 
      padding:20px; 
      background:#f5f5f5 
    }
    .message{ 
      margin-bottom:15px; 
      animation:fadeIn .3s 
    }
    @keyframes fadeIn { 
      from{opacity:0; transform:translateY(10px)} 
      to{opacity:1; transform:translateY(0)} 
    }
    .bot-message{ 
      text-align:left 
    } 
    .user-message{ 
      text-align:right 
    }
    .message-content{ 
      display:inline-block; 
      padding:12px 18px; 
      border-radius:18px; 
      max-width:80%; 
      word-wrap:break-word 
    }
    .bot-message .message-content{ 
      background:white; 
      color:#333; 
      box-shadow:0 2px 5px rgba(0,0,0,0.1) 
    }
    .user-message .message-content{ 
      background:#667eea; 
      color:white 
    }
    .button-group{ 
      margin-top:10px 
    }
    .chat-button{ 
      display:block; 
      width:100%; 
      padding:10px; 
      margin:5px 0; 
      background:#667eea; 
      color:white; 
      border:none; 
      border-radius:8px; 
      cursor:pointer; 
      font-size:14px 
    }
    .chat-button:hover{ 
      background:#5568d3 
    }
    .input-container{ 
      padding:15px; 
      background:white; 
      border-top:1px solid #ddd; 
      display:none 
    }
    .input-container.active{ 
      display:flex; 
      gap:10px 
    }
    .input-container input{ 
      flex:1; 
      padding:12px; 
      border:1px solid #ddd; 
      border-radius:25px; 
      font-size:14px 
    }
    .input-container button{ 
      padding:12px 20px; 
      background:#667eea; 
      color:white; 
      border:none; 
      border-radius:25px; 
      cursor:pointer; 
      font-size:14px 
    }
    .input-container button:hover{ 
      background:#5568d3 
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>Leave Management Chatbot</h1>
      <p>Your smart assistant for leave applications</p>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="input-container" id="inputContainer">
      <input type="text" id="userInput" placeholder="Type your message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    let chatState = 'initial';
    let leaveData = {};

    function addMessage(text, type, buttons = null) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}-message`;
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = text.replace(/\n/g, '<br>');
      messageDiv.appendChild(contentDiv);

      if (buttons && buttons.length > 0) {
        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'button-group';
        buttons.forEach(btn => {
          const button = document.createElement('button');
          button.className = 'chat-button';
          button.textContent = btn.text;
          button.onclick = () => handleButtonClick(btn.action, btn.text);
          buttonGroup.appendChild(button);
        });
        contentDiv.appendChild(buttonGroup);
      }

      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showInput() {
      document.getElementById('inputContainer').classList.add('active');
      document.getElementById('userInput').focus();
    }

    function hideInput() {
      document.getElementById('inputContainer').classList.remove('active');
    }

    function sendMessage() {
      const input = document.getElementById('userInput');
      const message = input.value.trim();
      if (!message) return;
      addMessage(message, 'user');
      input.value = '';

      fetch('/process_input', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message: message, state: chatState, leaveData: leaveData})
      }).then(res => res.json()).then(data => {
        chatState = data.state;
        leaveData = data.leaveData || {};
        setTimeout(() => {
          addMessage(data.response, 'bot', data.buttons);
          if (data.needsInput) showInput(); else hideInput();
        }, 300);
      });
    }

    function handleButtonClick(action, text) {
      addMessage(text, 'user');
      fetch('/handle_action', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action: action, leaveData: leaveData})
      }).then(res => res.json()).then(data => {
        chatState = data.state;
        leaveData = data.leaveData || {};
        setTimeout(() => {
          addMessage(data.response, 'bot', data.buttons);
          if (data.needsInput) showInput(); else hideInput();
        }, 300);
      });
    }

    document.getElementById('userInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });

    window.onload = function() {
      fetch('/init').then(res => res.json()).then(data => {
        addMessage(data.response, 'bot', data.buttons);
        chatState = data.state;
      });
    };
  </script>
</body>
</html>
